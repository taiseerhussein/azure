---
- name: Query Azure Update Manager for Pending Updates via REST API
  hosts: localhost # This playbook runs on the Ansible control node (or execution node)
  connection: local # It performs actions locally, querying Azure API

  vars:
    # Azure authentication details - these are typically populated by AAP's Azure Resource Manager credential
    # when assigned to the job template. Ensure your AAP credential is configured to pass these.
    azure_client_id: "{{ lookup('env', 'AZURE_CLIENT_ID') }}"
    azure_client_secret: "{{ lookup('env', 'AZURE_SECRET') }}"
    azure_tenant_id: "{{ lookup('env', 'AZURE_TENANT') }}"
    # azure_subscription_id: "{{ lookup('env', 'AZURE_SUBSCRIPTION_ID') }}" # Not directly used in ARG query body, but often available

    # Azure Resource Graph API endpoint
    # The API version for Resource Graph queries.
    arg_api_url: "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01"

    # Kusto Query Language (KQL) query to get pending software patches.
    # This query fetches individual pending patches (KB IDs for Windows) from Azure Resource Graph.
    # It assumes the machines are managed by Azure Update Manager and their assessments are in ARG.
    kql_query: |
      patchassessmentresources
      | where type has "softwarepatches" // Filter for individual software patch records
      | extend properties = parse_json(properties)
      | extend machineName = tostring(split(id, "/", 8)) // Extract machine name from resource ID
      | extend kbId = properties.kbId // Windows Knowledge Base ID
      | extend patchName = properties.patchName // Name of the patch
      | extend classification = properties.classification // Update classification (e.g., SecurityUpdates, CriticalUpdates)
      | extend rebootRequired = properties.rebootRequired // Indicates if a reboot is required
      | where isnull(properties.installationState) or properties.installationState == "Pending" // Filter for updates that are pending installation
      | project machineName, patchName, kbId, classification, rebootRequired // Select relevant fields for output
      | order by machineName, classification // Order the results for better readability

  tasks:
    - name: Query Azure Resource Graph for pending updates via REST API
      ansible.builtin.uri:
        url: "{{ arg_api_url }}"
        method: POST
        headers:
          Content-Type: "application/json" # Specify the content type for the request body
        body_format: json # Tell Ansible to format the 'body' as JSON
        body:
          query: "{{ kql_query }}" # The KQL query to execute
          # Optionally, you can specify target subscriptions or management groups for the query.
          # If not specified, the query runs against all subscriptions accessible by the service principal.
          # subscriptions:
          #   - "{{ azure_subscription_id }}"
        oauth2_token:
          client_id: "{{ azure_client_id }}" # Client ID of your Azure Service Principal
          client_secret: "{{ azure_client_secret }}" # Client Secret of your Azure Service Principal
          grant_type: client_credentials # Standard OAuth 2.0 grant type for application authentication
          resource: "https://management.azure.com/" # The resource/audience for the token (Azure Management API)
          token_url: "https://login.microsoftonline.com/{{ azure_tenant_id }}/oauth2/token" # Azure AD token endpoint
        status_code: 200 # Expect a 200 OK response for success
        validate_certs: true # Always keep this true in production for security
      register: azure_query_result # Store the API response
      changed_when: false # This task only queries data, it doesn't change anything

    - name: Parse Azure query result
      # The 'from_json' filter parses the JSON string from the API response into an Ansible dictionary/list.
      ansible.builtin.set_fact:
        pending_updates_data: "{{ azure_query_result.json }}"

    - name: Display summary of pending updates
      ansible.builtin.debug:
        msg: "--- Pending Updates Summary ---"

    - name: Group updates by machine and display
      # Use the 'groupby' filter to organize the updates by machine name.
      # The 'loop' iterates through each machine and its associated updates.
      ansible.builtin.debug:
        msg: |
          Machine: {{ item.key }}
            Updates:
          {% for update in item.value %}
              - Name: {{ update.patchName }} (KB: {{ update.kbId }})
                Classification: {{ update.classification }}
                Reboot Required: {{ 'Yes' if update.rebootRequired else 'No' }}
          {% endfor %}
      loop: "{{ pending_updates_data.data | groupby('machineName') }}"
      loop_control:
        label: "{{ item.key }}" # Label for the loop output in Ansible
      when: pending_updates_data.data | length > 0 # Only display if there are updates

    - name: Inform if no pending updates found
      ansible.builtin.debug:
        msg: "No pending updates found via Azure Update Manager."
      when: pending_updates_data.data | length == 0 # Display if no updates were found