---
- name: Query Azure Update Manager for Pending Updates via REST API
  hosts: localhost # This playbook runs on the Ansible control node (or execution node)
  connection: local # It performs actions locally, querying Azure API

  vars:
    # Azure authentication details - these are typically populated by AAP's Azure Resource Manager credential
    # when assigned to the job template. Ensure your AAP credential is configured to pass these.
    azure_client_id: "{{ lookup('env', 'AZURE_CLIENT_ID') }}"
    azure_client_secret: "{{ lookup('env', 'AZURE_SECRET') }}"
    azure_tenant_id: "{{ lookup('env', 'AZURE_TENANT') }}"
    # azure_subscription_id: "{{ lookup('env', 'AZURE_SUBSCRIPTION_ID') }}" # Not directly used in ARG query body, but often available

    # Azure AD token endpoint for client credentials flow
    azure_token_url: "https://login.microsoftonline.com/{{ azure_tenant_id }}/oauth2/token"
    azure_resource_uri: "https://management.azure.com/" # The resource/audience for the token

    # Azure Resource Graph API endpoint
    # The API version for Resource Graph queries.
    arg_api_url: "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01"

    # Kusto Query Language (KQL) query to get pending software patches.
    # This query fetches individual pending patches (KB IDs for Windows) from Azure Resource Graph.
    # It assumes the machines are managed by Azure Update Manager and their assessments are in ARG.
    kql_query: |
      patchassessmentresources
      | where type has "softwarepatches" // Filter for individual software patch records
      | extend properties = parse_json(properties)
      | extend machineName = tostring(split(id, "/", 8)) // Extract machine name from resource ID
      | extend kbId = properties.kbId // Windows Knowledge Base ID
      | extend patchName = properties.patchName // Name of the patch
      | extend classification = properties.classification // Update classification (e.g., SecurityUpdates, CriticalUpdates)
      | extend rebootRequired = properties.rebootRequired // Indicates if a reboot is required
      | where isnull(properties.installationState) or properties.installationState == "Pending" // Filter for updates that are pending installation
      | project machineName, patchName, kbId, classification, rebootRequired // Select relevant fields for output

  tasks:
    - name: Get OAuth2 token from Azure AD
      ansible.builtin.uri:
        url: "{{ azure_token_url }}"
        method: POST
        body_format: form-urlencoded
        headers:
          Content-Type: "application/x-www-form-urlencoded" # Required for token endpoint
        body:
          grant_type: client_credentials
          client_id: "{{ azure_client_id }}"
          client_secret: "{{ azure_client_secret }}"
          resource: "{{ azure_resource_uri }}"
        status_code: 200
       # validate_certs: true
      register: azure_auth_token_response
      # no_log: true # Prevent sensitive token from being logged
      changed_when: false

    - name: Set access token fact
      ansible.builtin.set_fact:
        access_token: "{{ azure_auth_token_response.json.access_token }}"
      # no_log: true # Prevent sensitive token from being logged

    - name: Query Azure Resource Graph for pending updates via REST API
      ansible.builtin.uri:
        url: "{{ arg_api_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
          Authorization: "Bearer {{ access_token }}" # Use the obtained access token here
        body_format: json
        body:
          query: "{{ kql_query }}"
          # Optionally, you can specify target subscriptions or management groups for the query.
          # If not specified, the query runs against all subscriptions accessible by the service principal.
          # subscriptions:
          #   - "{{ azure_subscription_id }}"
        status_code: 200
        validate_certs: true
      register: azure_query_result
      changed_when: false

    - name: Parse Azure query result
      ansible.builtin.set_fact:
        pending_updates_data: "{{ azure_query_result.json }}"

    - name: Display summary of pending updates
      ansible.builtin.debug:
        msg: "--- Pending Updates Summary --- {{ azure_query_result }}"

    - name: Group updates by machine and display
      ansible.builtin.debug:
        msg: |
          Updates:
          {% for update in item.value %}
              - Name: {{ update.patchName }} (KB: {{ update.kbId }})
                Classification: {{ update.classification }}
                Reboot Required: {{ 'Yes' if update.rebootRequired else 'No' }}
          {% endfor %}
      loop: "{{ pending_updates_data.data | groupby('machineName') }}"
      when: pending_updates_data.data | length > 0

    - name: Inform if no pending updates found
      ansible.builtin.debug:
        msg: "No pending updates found via Azure Update Manager."
      when: pending_updates_data.data | length == 0
